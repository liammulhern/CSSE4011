policies:
  # ──────────────────────── Suppliers ────────────────────────
  - name: Supplier_View_Orders_They_Receive
    description: "Suppliers can see orders placed TO them by manufacturers."
    effect: allow
    subject_attributes:
      - { name: company_type, value: supplier }
    resource_attributes:
      - { name: receiver_company_id,     value: "${subject.company_id}" }
    actions: [ view_order ]

  - name: Supplier_Record_Shipment_Event
    description: "Suppliers can record shipment events for orders they supply."
    effect: allow
    subject_attributes:
      - { name: company_type, value: supplier }
    resource_attributes:
      - { name: supplier_company_id,     value: "${subject.company_id}" }
    actions: [ create_event ]

  # ─────────────────────── Manufacturers ─────────────────────
  - name: Manufacturer_Create_Orders
    description: "Manufacturers can place orders to suppliers."
    effect: allow
    subject_attributes:
      - { name: company_type, value: manufacturer }
    resource_attributes: []
    actions: [ create_order ]

  - name: Manufacturer_View_Orders_They_Supply
    description: "Manufacturers can view orders they have placed as suppliers to retailers."
    effect: allow
    subject_attributes:
      - { name: company_type, value: manufacturer }
    resource_attributes:
      - { name: supplier_company_id,     value: "${subject.company_id}" }
    actions: [ view_order ]

  - name: Manufacturer_Record_Manufacture_Event
    description: "Manufacturers can record 'manufactured' events for products they create."
    effect: allow
    subject_attributes:
      - { name: company_type, value: manufacturer }
    # assume event.resource_attr product_owner_id == subject.company_id
    resource_attributes:
      - { name: product_owner_id,        value: "${subject.company_id}" }
    actions: [ create_event ]

  # ─────────────────────── Distributors ─────────────────────
  - name: Distributor_View_Custody_Transfers
    description: "Distributors can view any custody transfer they are part of."
    effect: allow
    subject_attributes:
      - { name: company_type, value: distributor }
    resource_attributes:
      - { name: from_company_id,         value: "${subject.company_id}" }
      - { name: to_company_id,           value: "${subject.company_id}" }
    actions: [ view_custody_transfer ]

  - name: Distributor_Record_Custody_Transfer
    description: "Distributors can record custody transfers when handling shipments."
    effect: allow
    subject_attributes:
      - { name: company_type, value: distributor }
    resource_attributes:
      - { name: from_company_id,         value: "${subject.company_id}" }
      - { name: to_company_id,           value: "${subject.company_id}" }
    actions: [ create_custody_transfer ]

  # ──────────────────────── Retailers ───────────────────────
  - name: Retailer_View_Orders_They_Receive
    description: "Retailers can view orders placed TO them."
    effect: allow
    subject_attributes:
      - { name: company_type, value: retailer }
    resource_attributes:
      - { name: receiver_company_id,     value: "${subject.company_id}" }
    actions: [ view_order ]

  - name: Retailer_Record_Sale_Event
    description: "Retailers can record the final sale event for products they own."
    effect: allow
    subject_attributes:
      - { name: company_type, value: retailer }
    resource_attributes:
      - { name: product_owner_id,        value: "${subject.company_id}" }
    actions: [ create_event ]

  - name: Retailer_Record_Custody_Transfer
    description: "Retailers record receipt from Distributors."
    effect: allow
    subject_attributes:
      - { name: company_type, value: retailer }
    resource_attributes:
      - { name: to_company_id,           value: "${subject.company_id}" }
    actions: [ create_custody_transfer ]

  # ──────────────────────── Consumers ───────────────────────
  - name: Consumer_View_Product_Passport
    description: "Consumers can view events only for products they have scanned."
    effect: allow
    subject_attributes:
      - { name: company_type, value: consumer }
      - { name: scanned_products,       value: "${resource.product_key}" }
    resource_attributes:
      - { name: product_key,             value: "${subject.scanned_products}" }
    actions: [ view_event ]

  # ───────────────────────── Admin ──────────────────────────
  - name: Admin_Full_Access
    description: "Superusers can do anything."
    effect: allow
    subject_attributes:
      - { name: is_superuser, value: "True" }
    resource_attributes: []
    actions: [ "*" ]

